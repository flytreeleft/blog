# https://help.github.com/en/articles/workflow-syntax-for-github-actions
name: Node CI
on:
  push:
    branches:
    - 'master'
    paths-ignore:
    - 'build/**'
jobs:
  build-and-deploy-gh-pages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x]
    steps:
    - name: Pull source code
      # https://github.com/actions/checkout
      uses: actions/checkout@v2
      with:
        submodules: true
    - name: Restore last modified time
      run: |
        # https://github.com/theme-next/hexo-theme-next/issues/893#issuecomment-498080459
        git ls-files -z | while read -d '' path; do touch -d "$(git log -1 --format="@%ct" "$path")" "$path"; done

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}
    - name: Build with NPM
      run: |
        npm install -g yarn
        yarn install
        npm run clean
        npm run _build -- --config config.yml,github.yml
        cp README.md dist/
    # https://github.com/marketplace/actions/release-github-pages
    # https://github.com/peaceiris/actions-gh-pages
    - name: Deploy Github Pages
      uses: ./.github/actions/deploy-gh-pages
      env:
        # https://github.com/peaceiris/actions-gh-pages#1-add-ssh-deploy-key
        # - ssh-keygen -t rsa -b 4096 -C "$(git config user.email)" -f gh-pages -N ""
        ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        GITHUB_PAGES_REPO_AUTHOR: ${{ github.actor }}
        GITHUB_PAGES_REPO_NAME: ${{ github.actor }}.github.io
        GITHUB_PAGES_RELEASE_BRANCH: master
        PROJECT_BUILD_FOLDER: dist
        GITHUB_PAGES_CLEANUP_SCRIPT: "git clean -d -f && git rm -r *"
